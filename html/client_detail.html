<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Detail</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f4f4f4;
      transition: direction 0.3s;
    }

    header {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      text-align: center;
    }

    .lang-toggle {
      position: absolute;
      top: 10px;
      left: 10px;
    }


    nav {
      display: flex;
      justify-content: space-around;
      background: #34495e;
      padding: 0.5rem 0;
      flex-wrap: wrap;
    }

    nav a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }

    .card {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
    }
    .card input, .card textarea, .card select {
      display: block;
      margin: 0.5rem 0 1rem;
      padding: 0.5rem;
      width: 100%;
    }
    main {
      padding: 1.5rem;
      display: flex;
      gap: 1rem;
      align-items: stretch;
    }
    
    button {
        appearance: auto;
        text-rendering: auto;
        letter-spacing: normal;
        word-spacing: normal;
        line-height: normal;
        text-transform: none;
        text-indent: 0px;
        text-shadow: none;
        display: inline-block;
        text-align: center;
        cursor: default;
        box-sizing: border-box;
        margin: 0em;
        padding-block: 1px;
        padding-inline: 6px;
        border-width: 2px;
        border-style: outset;
        border-color: buttonborder;
        border-image: initial;
    }


    .btn-save { background: #27ae60; color: white; }
    .btn-delete { background: #c0392b; color: white; }
    .btn-back {
      background: #3498db;
      color: white;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

  <div class="lang-toggle">
    <button onclick="setLanguage('en')">English</button>
    <button onclick="setLanguage('ar')">العربية</button>
  </div>

  <header>
    <h1 id="clients-header">Clients</h1>
    <p id="clients-subtext">View and manage your current clients</p>
  </header>

  <nav>
    <a href="trainer_home.html" id="nav-home">Home</a>
    <a href="clients.html" id="nav-clients">Clients</a>
    <a href="plans.html" id="nav-plans">Plans</a>
    <a href="#" id="nav-progress">Progress</a>
    <a href="settings.html" id="nav-settings">Settings</a>
  </nav>


<form class="card" id="client-form">
  <h2 id="client-name">Client Detail</h2>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div>
      <label for="full_name">Full Name</label>
      <input type="text" id="full_name" placeholder="Full Name" />
    </div>
    <div>
      <label for="phone">Phone Number</label>
      <input type="tel" id="phone" placeholder="Phone Number" />
    </div>
    <div>
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="Email" />
    </div>
    <div>
      <label for="age">Age</label>
      <input type="number" id="age" placeholder="Age" />
    </div>
    <div>
      <label for="weight">Weight (kg)</label>
      <input type="number" id="weight" placeholder="Weight (kg)" />
    </div>
    <div>
      <label for="height">Height (cm)</label>
      <input type="number" id="height" placeholder="Height (cm)" />
    </div>
  </div>
  <div style="display: flex; gap: 20px; margin-top: 20px;">
    <div style="flex: 0.25;">
      <label for="goal">Goal</label>
      <select id="goal" style="width: 100%;">
        <option value="">-- Select Goal --</option>
        <option value="fat_loss">Fat Loss</option>
        <option value="muscle_gain">Muscle Gain</option>
        <option value="maintenance">Maintenance</option>
      </select>
    </div>
    <div style="flex: 0.75;">
      <label for="notes">Notes</label>
      <textarea id="notes" placeholder="Notes" style="width: 100%; height: 100px;"></textarea>
    </div>
  </div>
</form>
<form>
  <div style="margin-top: 20px;">
    <div style="display: flex; align-items: center; margin-bottom: 1rem;">
      <h3 style="margin: 0 10px 0 0;">Membership Active</h3>
      <input type="checkbox" id="membership_active" style="transform: scale(1.3);" />
    </div>
    <label for="start_date" style="margin-left: 20px;">Start Date</label>
    <input type="date" id="start_date" />
    <label for="end_date" style="margin-left: 20px;">End Date</label>
    <input type="date" id="end_date" />
  </div>
</form>

  <div class="card">
    <h3>Assigned Plan</h3>
    <ul id="assigned-plans-list">
      <li>Loading...</li>
    </ul>
    <select id="plan-select">
      <option value="">-- Select a Plan --</option>
    </select>
    <button id="assign-plan-btn">Assign Plan</button>
  </div>

  <div class="card">
    <h2>Client Pictures</h2>
    <hr />
    <div style="display: flex; justify-content: center; align-items: flex-start; gap: 80px; flex-wrap: wrap;">

      <!-- Before Picture -->
      <div style="text-align: center;">
        <h3>Before</h3>
        <img id="before-pic" src="" alt="Before"
            style="width: 250px; height: 250px; object-fit: cover; border-radius: 10px; border: 2px solid #aaa;" />
        <br />
        <input type="file" id="before-upload" accept="image/*" />
        <p id="before-uploaded-date" style="font-size: 0.9em; color: gray;"></p>
      </div>

      <!-- Vertical Separator -->
      <div style="width: 1px; height: 280px; background-color: #bbb;"></div>

      <!-- After Picture -->
      <div style="text-align: center;">
        <h3>After</h3>
        <img id="after-pic" src="" alt="After"
            style="width: 250px; height: 250px; object-fit: cover; border-radius: 10px; border: 2px solid #aaa;" />
        <br />
        <input type="file" id="after-upload" accept="image/*" />
        <p id="after-uploaded-date" style="font-size: 0.9em; color: gray;"></p>
      </div>

    </div>
  </div>

  <div style="text-align: center; margin: 2rem 0;">
    <button class="btn-save">Save Changes</button>
    <button class="btn-delete">Delete Client</button>
    <button id="btn-back" class="btn-back">⬅️ Back to Clients</button>
  </div>

  <script>
    async function uploadClientPhoto(label, file) {
      if (!file || !clientId) return;

      const formData = new FormData();
      formData.append("client_id", clientId);
      formData.append("label", label);
      formData.append("file", file);

      try {
        const res = await fetch("http://localhost:8000/upload_photo/", {
          method: "POST",
          body: formData
        });

        if (!res.ok) throw new Error("Upload failed");
        const data = await res.json();
        alert(`✅ ${label} photo uploaded.`);
        return data.image_url;
      } catch (err) {
        console.error(`Error uploading ${label} photo:`, err);
        alert(`❌ Failed to upload ${label} photo.`);
      }
    }

    document.getElementById('before-upload').addEventListener('change', async function (e) {
      const file = e.target.files[0];
      if (file) {
        const url = await uploadClientPhoto('before', file);
        if (url) document.getElementById('before-pic').src = url;
      }
    });

    document.getElementById('after-upload').addEventListener('change', async function (e) {
      const file = e.target.files[0];
      if (file) {
        const url = await uploadClientPhoto('after', file);
        if (url) document.getElementById('after-pic').src = url;
      }
    });
  </script>



  <script>
    const clientId = new URLSearchParams(window.location.search).get("id");
    if (!clientId) {
      alert("Missing client ID in URL");
      window.location.href = "clients.html";
    }

    async function loadClient() {
      try {
        const res = await fetch(`http://localhost:8000/api/clients/${clientId}`);
        if (!res.ok) throw new Error("Client not found");
        const client = await res.json();

        document.getElementById("client-name").textContent = client.full_name;
        document.getElementById("full_name").value = client.full_name;
        document.getElementById("email").value = client.email;
        document.getElementById("phone").value = client.phone || "";
        document.getElementById("age").value = client.age;
        document.getElementById("weight").value = client.weight;
        document.getElementById("height").value = client.height;
        document.getElementById("goal").value = client.goal;
        document.getElementById("notes").value = client.notes;
        document.getElementById("membership_active").checked = client.membership_active;
        document.getElementById("start_date").value = client.start_date;
        document.getElementById("end_date").value = client.end_date || "";
      } catch (err) {
        console.error("Error loading client:", err);
        alert("Failed to load client details.");
        window.location.href = "clients.html";
      }
    }

    async function saveChanges() {
      if (!confirm("Are you sure you want to save changes?")) return;
      document.querySelector(".btn-save").disabled = true;

      try {
        const res = await fetch(`http://localhost:8000/api/clients/${clientId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            full_name: document.getElementById("full_name").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value,
            age: parseInt(document.getElementById("age").value),
            weight: parseFloat(document.getElementById("weight").value),
            height: parseFloat(document.getElementById("height").value),
            goal: document.getElementById("goal").value,
            notes: document.getElementById("notes").value,
            membership_active: document.getElementById("membership_active").checked,
            start_date: document.getElementById("start_date").value,
            end_date: document.getElementById("end_date").value,
          }),
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error("Update failed:", errorText);
          alert("Update failed, returning to client list.");
          window.location.href = "clients.html";
        } else {
          alert("Client updated successfully.");
          window.location.href = "clients.html";
        }
      } catch (err) {
        console.error("Error updating client:", err);
        alert("An error occurred, returning to client list.");
        window.location.href = "clients.html";
      }
    }

    async function confirmDelete() {
      if (!confirm("Are you sure you want to delete this client? This action is irreversible.")) return;
      document.querySelector(".btn-delete").disabled = true;

      try {
        const res = await fetch(`http://localhost:8000/api/clients/${clientId}`, { method: "DELETE" });
        if (!res.ok) {
          const errorText = await res.text();
          console.error("Delete failed:", errorText);
          alert("Delete failed, returning to client list.");
        } else {
          alert("Client deleted successfully.");
        }
      } catch (err) {
        console.error("Error deleting client:", err);
        alert("An error occurred, returning to client list.");
      }

      window.location.href = "clients.html";
    }

    document.querySelector(".btn-save").addEventListener("click", saveChanges);
    document.querySelector(".btn-delete").addEventListener("click", confirmDelete);
    document.getElementById("btn-back").addEventListener("click", () => {
      window.location.href = "clients.html";
    });

    async function loadPlans() {
      try {
        const res = await fetch("http://localhost:8000/api/plans/");
        if (!res.ok) throw new Error("Failed to load plans");
        const plans = await res.json();
        const select = document.getElementById("plan-select");
        plans.forEach(plan => {
          const option = document.createElement("option");
          option.value = plan.id;
          option.textContent = `${plan.name} (${plan.type})`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error("Error loading plans:", err);
        alert("❌ Failed to load plans");
      }
    }

    async function loadAssignedPlans() {
      try {
        const res = await fetch(`http://localhost:8000/api/client_plans/${clientId}/history`);
        if (!res.ok) throw new Error("Failed to load assigned plans");
        const assigned = await res.json();
        const list = document.getElementById("assigned-plans-list");
        list.innerHTML = "";
        if (assigned.length === 0) {
          list.innerHTML = "<li>No plan currently assigned.</li>";
          return;
        }

        for (const entry of assigned) {
          try {
            const planRes = await fetch(`http://localhost:8000/api/plans/${entry.plan_id}`);
            if (!planRes.ok) throw new Error("Plan not found");
            const plan = await planRes.json();
            const li = document.createElement("li");
            li.textContent = `${plan.name || "Unnamed Plan"} – Assigned on ${new Date(entry.assigned_on).toLocaleDateString()}`;
            list.appendChild(li);
          } catch (planErr) {
            console.error("Error loading plan details:", planErr);
            const li = document.createElement("li");
            li.textContent = `Plan ID ${entry.plan_id} – Assigned on ${new Date(entry.assigned_on).toLocaleDateString()}`;
            list.appendChild(li);
          }
        }
      } catch (err) {
        console.error("Error loading assigned plans:", err);
        alert("❌ Failed to load assigned plans");
      }
    }

    async function assignPlan() {
      const planId = document.getElementById("plan-select").value;
      if (!planId) return alert("Please select a plan first.");
      try {
        const res = await fetch("http://localhost:8000/api/client_plans/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ client_id: parseInt(clientId), plan_id: parseInt(planId) })
        });
        if (!res.ok) throw new Error("Failed to assign plan");
        alert("✅ Plan assigned successfully.");
        loadAssignedPlans();
      } catch (err) {
        console.error("Error assigning plan:", err);
        alert("❌ Failed to assign plan.");
      }
    }

    document.getElementById("assign-plan-btn").addEventListener("click", assignPlan);

    async function loadClientPhotos() {
      try {
        const res = await fetch(`http://localhost:8000/api/clients/${clientId}/photos`);
        if (!res.ok) throw new Error("Failed to load photos");
        const photos = await res.json();

        for (const photo of photos) {
          const imageUrl = photo.image_url;  // assume this is already complete and correct

          if (photo.label.toLowerCase() === "before" || imageUrl.includes("before")) {
            document.getElementById("before-pic").src = imageUrl;
          } else if (photo.label.toLowerCase() === "after" || imageUrl.includes("after")) {
            document.getElementById("after-pic").src = imageUrl;
          }
        }
      } catch (err) {
        console.error("Error loading client photos:", err);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadClient();
      loadPlans();
      loadAssignedPlans();
      loadClientPhotos();
    });
  </script>
</body>
</html>

